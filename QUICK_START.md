# Pandora Scheduler - Quick Start Guide

## Running the Complete Pipeline

The `run_scheduler.py` script is the **main entry point** for the Pandora Scheduler. It runs the complete observation scheduling pipeline from start to finish, handling target manifest generation, visibility calculation, and schedule optimization.

### Prerequisites

Running the full pipeline requires two external inputs that are NOT included in this repository:

1. **Target Definition Files** — Clone or download from [PandoraMission/PandoraTargetList](https://github.com/PandoraMission/PandoraTargetList). The scheduler uses the `target_definition_files/` directory which contains JSON files for exoplanet, auxiliary-standard, monitoring-standard, and occultation-standard targets.

2. **GMAT Ephemeris File** — A text file containing the Pandora spacecraft ephemeris generated by GMAT. This is required for visibility calculations.

Visibility catalogs are NOT pregenerated or distributed. You must generate them using `--generate-visibility` together with a GMAT ephemeris file.

### Basic Usage

```bash
poetry run python run_scheduler.py \
    --start "2026-02-05" \
    --end "2026-02-12" \
    --output ./output \
    --target-definitions /path/to/PandoraTargetList/target_definition_files \
    --generate-visibility \
    --gmat-ephemeris /path/to/ephemeris.txt
```

This will:
1. Generate target manifests from JSON definition files (exoplanet, auxiliary-standard, monitoring-standard, occultation-standard)
2. Generate visibility catalogs for all targets
3. Run the scheduling algorithm
4. Generate all output files

This will generate:
- **Target Manifests**: `exoplanet_targets.csv`, `auxiliary-standard_targets.csv`, etc. (in output/data/)
- **Visibility Files**: Time-series visibility data for each target (in output/data/targets/ and output/data/aux_targets/)
- **Schedule CSV**: Complete observation schedule
- **Science Calendar XML**: XML format for spacecraft planning
- **Observation Time Report**: Time allocation per target
- **Tracker files**: CSV and pickle formats for state tracking

### Output Files

When using `--target-definitions` and `--generate-visibility`, files are organized as:

```
output/
├── data/                                          # Generated data
│   ├── exoplanet_targets.csv                    # Primary targets manifest
│   ├── auxiliary-standard_targets.csv           # Auxiliary targets
│   ├── monitoring-standard_targets.csv          # Monitoring targets
│   ├── occultation-standard_targets.csv         # Occultation targets
│   ├── targets/                                  # Primary target visibility
│   │   └── StarName/
│   │       └── PlanetName/
│   │           └── Visibility for PlanetName.parquet
│   └── aux_targets/                              # Auxiliary target visibility
│       └── StarName/
│           └── Visibility for StarName.parquet
├── Pandora_Schedule_0.8_0.0_0.2_2026-02-05_to_2026-02-12.csv
├── Pandora_science_calendar.xml
├── Observation_Time_Report_2026-02-05 00:00:00.csv
├── tracker.csv
└── Tracker_2026-02-05_to_2026-02-12.pkl
```

### Common Workflows

#### Complete Pipeline (Recommended)
Generate everything from scratch using target definitions:
```bash
poetry run python run_scheduler.py \
    --start "2026-02-05" \
    --end "2026-02-12" \
    --output ./full_pipeline_output \
    --target-definitions /path/to/PandoraTargetList/target_definition_files \
    --generate-visibility \
    --gmat-ephemeris /path/to/ephemeris.txt \
    --show-progress
```

#### Using Existing Manifests (Fast)
If you already have generated target manifests and visibility files:
```bash
poetry run python run_scheduler.py \
    --start "2026-02-05" \
    --end "2026-02-12" \
    --output ./output
```

#### Show Progress Bars
```bash
poetry run python run_scheduler.py \
    --start "2026-02-05" \
    --end "2026-02-12" \
    --output ./output \
    --show-progress
```

#### Custom Weights
Schedule weights control prioritization (coverage, SAA, schedule factor):
```bash
poetry run python run_scheduler.py \
    --start "2026-02-05" \
    --end "2026-02-12" \
    --output ./output \
    --weights "0.9,0.0,0.1"
```

#### Skip XML Generation
For faster testing when you only need the CSV schedule:
```bash
poetry run python run_scheduler.py \
    --start "2026-02-05" \
    --end "2026-02-12" \
    --output ./output \
    --skip-xml
```

#### Verbose Logging
```bash
poetry run python run_scheduler.py \
    --start "2026-02-05" \
    --end "2026-02-12" \
    --output ./output \
    --verbose
```

### Advanced Usage

#### Using a Configuration File

Create `config.json`:
```json
{
    "schedule_step_hours": 24.0,
    "transit_coverage_min": 0.4,
    "transit_scheduling_weights": [0.8, 0.0, 0.2],
    "min_visibility": 0.5,
    "deprioritization_limit_hours": 48.0,
    "commissioning_days": 0,
    "show_progress": true
}
```

Run with config:
```bash
poetry run python run_scheduler.py \
    --start "2026-02-05" \
    --end "2026-02-12" \
    --output ./output \
    --config config.json
```

A ready-made example config is provided at the repository root: `example_scheduler_config.json`.
For a full key reference see `docs/EXAMPLE_SCHEDULER_CONFIG.md`.


#### Visibility Generation

If you need to regenerate visibility catalogs from target definitions:
```bash
poetry run python run_scheduler.py \
    --start "2026-02-05" \
    --end "2026-02-12" \
    --output ./output \
    --target-definitions /path/to/PandoraTargetList/target_definition_files \
    --generate-visibility \
    --gmat-ephemeris /path/to/ephemeris.txt
```

**Note:** If `--target-definitions` is provided, the script will:
1. Generate `*_targets.csv` manifests in `output/data/`
2. If `--generate-visibility` is set, create visibility files in `output/data/targets/` and `output/data/aux_targets/`
3. Use these generated files for scheduling

#### Custom Avoidance Angles

```bash
poetry run python run_scheduler.py \
    --start "2026-02-05" \
    --end "2026-02-12" \
    --output ./output \
    --generate-visibility \
    --gmat-ephemeris /path/to/ephemeris.txt \
    --sun-avoidance 90.0 \
    --moon-avoidance 30.0 \
    --earth-avoidance 85.0
```

### Command-Line Reference

#### Required Arguments
- `--start DATE` - Schedule window start (YYYY-MM-DD or YYYY-MM-DD HH:MM:SS)
- `--end DATE` - Schedule window end
- `--output DIR` - Output directory

#### Scheduling Parameters
- `--schedule-step-hours HOURS` - Scheduler rolling window step size in hours (default: 24.0)
- `--transit-coverage FRACTION` - Minimum transit coverage (default: 0.4)
- `--weights W1,W2,W3` - Schedule weights: coverage,saa,schedule (default: 0.8,0.0,0.2)
- `--min-visibility FRACTION` - Minimum visibility for auxiliary targets (default: 0.5)

#### Visibility Generation
- `--generate-visibility` - Generate visibility catalogs
- `--gmat-ephemeris PATH` - GMAT ephemeris file
- `--sun-avoidance DEGREES` - Sun avoidance angle (default: 91.0)
- `--moon-avoidance DEGREES` - Moon avoidance angle (default: 25.0)
- `--earth-avoidance DEGREES` - Earth avoidance angle (default: 86.0)

#### Pipeline Control
- `--config PATH` - JSON configuration file
- `--target-definitions DIR` - Base directory for target definition files (PandoraTargetList/target_definition_files/)
- `--skip-xml` - Skip science calendar XML generation
- `--skip-manifests` - Skip regenerating target manifests from target definition files
- `--show-progress` - Show progress bars
- `--legacy-mode` - Use legacy scheduling algorithms for validation
- `-v, --verbose` - Enable verbose logging

### Examples

#### Full Pipeline from Target Definitions
```bash
poetry run python run_scheduler.py \
    --start "2026-02-05" \
    --end "2026-02-12" \
    --output ./complete_run \
    --target-definitions /path/to/PandoraTargetList/target_definition_files \
    --generate-visibility \
    --gmat-ephemeris /path/to/ephemeris.txt \
    --show-progress \
    --verbose
```

#### Quick 2-Day Test with Existing Data
```bash
poetry run python run_scheduler.py \
    --start "2026-02-05" \
    --end "2026-02-07" \
    --output ./quick_test \
    --show-progress
```

#### Full Year Run
```bash
poetry run python run_scheduler.py \
    --start "2026-02-05" \
    --end "2027-02-05" \
    --output ./full_run \
    --show-progress \
    --verbose
```

#### Custom Scheduling Strategy
```bash
poetry run python run_scheduler.py \
    --start "2026-02-05" \
    --end "2026-02-12" \
    --output ./custom \
    --weights "0.7,0.1,0.2" \
    --min-visibility 0.6 \
    --schedule-step-hours 20.0
```

### Troubleshooting

#### "Target manifest not found"
Provide target definitions to generate manifests:
```bash
--target-definitions /path/to/PandoraTargetList/target_definition_files
```

#### "Target definition directory not found"
Check that the path to `PandoraTargetList/target_definition_files` is correct. It should contain subdirectories like:
- `exoplanet/`
- `auxiliary-standard/`
- `monitoring-standard/`
- `occultation-standard/`

Each containing JSON target definition files.

#### Visibility Generation Issues
If visibility generation fails:
1. Ensure `--target-definitions` is provided (manifests must exist first)
2. Ensure a GMAT ephemeris file exists and is supplied with `--gmat-ephemeris /path/to/ephemeris.txt` (there is no default provided by the package)
3. Verify target manifest was generated successfully
4. Use `--verbose` to see detailed error messages

#### "Weights must sum to 1.0"
The three schedule weights must sum to exactly 1.0:
```bash
--weights "0.8,0.0,0.2"  # Valid: 0.8 + 0.0 + 0.2 = 1.0
--weights "0.9,0.0,0.2"  # Invalid: sum = 1.1
```

#### Memory Usage
For long scheduling windows (>30 days), the process may require significant memory.

### Performance
Typical execution times on a modern laptop:
- 2-day window: ~2-3 minutes
- 7-day window: ~8-10 minutes
- Full year window: ~45-60 minutes

The `--show-progress` flag provides real-time progress updates.

### Integration with Testing

To verify parity with legacy code:
```bash
# Run the main script
poetry run python run_scheduler.py \
    --start "2026-02-05" \
    --end "2026-02-12" \
    --output ./test_output

# Compare with legacy using comparison script
poetry run python scripts/run_schedule_comparison.py \
    --window-days 7
```
