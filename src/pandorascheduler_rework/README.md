# pandorascheduler_rework

Short package README for the rework module. This file provides a compact developer-focused
quick start and examples for running the scheduler from the `pandorascheduler_rework` package.

## Purpose

This package contains the reworked scheduler implementation used by the repository's
`run_scheduler.py` entrypoint. It exposes the pipeline, configuration dataclass, and
helpers used to generate target manifests, visibility catalogs, schedules and XML outputs.

## Installation & Setup

Follow these steps to prepare a development environment and run the scheduler.

Prerequisites:
- Python 3.10+ installed
- `poetry` for dependency management
- **Target Definition Files** ‚Äî Clone from [PandoraMission/PandoraTargetList](https://github.com/PandoraMission/PandoraTargetList). Use the `target_definition_files/` directory.
- **GMAT Ephemeris File** ‚Äî A spacecraft ephemeris file generated by GMAT (required for visibility generation).

Install dependencies and create an environment:

```zsh
# from repository root
poetry install
```

Run the quick test (assumes required manifests/visibility already present ‚Äî visibility files are NOT distributed; generate them with `--generate-visibility` if needed):

```zsh
poetry run python run_scheduler.py \
  --start "2026-02-05" \
  --end "2026-02-07" \
  --output ./output_test
```

Full pipeline example (generates manifests and visibility). You MUST provide a GMAT ephemeris
file when using `--generate-visibility` as shown below:

```fish
poetry run python run_scheduler.py \
  --start "2026-02-05" \
  --end "2026-02-12" \
  --output ./output_standalone \
  --target-definitions /path/to/PandoraTargetList/target_definition_files \
  --generate-visibility \
  --gmat-ephemeris /path/to/ephemeris.txt \
  --show-progress
```

Run tests:

```zsh
poetry run pytest tests/ -q
```


## Quick Usage

From the repository root run the top-level `run_scheduler.py` script. Typical examples:

- Full pipeline (generate manifests and visibility):

```bash
poetry run python run_scheduler.py \
  --start "2026-02-05" \
  --end "2026-02-12" \
  --output ./output_standalone \
  --target-definitions /path/to/PandoraTargetList/target_definition_files \
  --generate-visibility \
  --gmat-ephemeris /path/to/ephemeris.txt \
  --show-progress
```

- Generate manifests only (faster):

```bash
poetry run python run_scheduler.py \
  --start "2026-02-05" \
  --end "2026-02-12" \
  --output ./output_standalone \
  --target-definitions /path/to/PandoraTargetList/target_definition_files
```

- Use existing manifests (no generation):

```bash
poetry run python run_scheduler.py \
  --start "2026-02-05" \
  --end "2026-02-07" \
  --output ./output_standalone
```

## Important Note about Visibility Generation

When using `--generate-visibility`, you must supply a GMAT ephemeris file with
`--gmat-ephemeris /path/to/ephemeris.txt`. Visibility generation requires the ephemeris
to compute orbital geometry and will fail or produce incorrect results without it.

The repository and package do not distribute pregenerated visibility catalogs. You must
generate visibility files yourself using `--generate-visibility` and a valid GMAT
ephemeris file supplied via `--gmat-ephemeris`.

---

# Pandora Scheduler Rework - Codebase Map

This directory contains the refactored scheduler implementation. Here is a guide to the structure and key files.

## üìÇ Directory Structure

### `src/pandorascheduler_rework/`
The main package containing all source code.

*   **`scheduler.py`**: **CORE LOGIC**. Contains the main scheduling loop (`run_scheduler`). Decides *what* to observe and *when*.
*   **`science_calendar.py`**: **OUTPUT GENERATOR**. Converts the schedule into the XML format required by the spacecraft.
*   **`pipeline.py`**: **ENTRY POINT**. Orchestrates the entire process (Data Load -> Visibility -> Schedule -> Output). Contains `build_schedule`.
*   **`config.py`**: **CONFIGURATION**. The new unified configuration system (`PandoraSchedulerConfig`).
*   **`observation_utils.py`**: **HELPERS**. Domain-specific helpers for observation sequences and coordinates.


### Subdirectories

*   **`visibility/`**: **GEOMETRY & PHYSICS**.
    *   Calculates what the satellite can see.
    *   Handles GMAT ephemeris files and coordinate transformations.
    *   Key files: `catalog.py` (generates visibility windows), `geometry.py` (coordinate transformations).

*   **`targets/`**: **TARGET MANIFEST GENERATION**.
    *   Builds target CSV manifests from JSON definition files.
    *   Key file: `manifest.py` (processes target definitions).

*   **`xml/`**: **XML BUILDING UTILITIES**.
    *   Constructs XML elements for science calendar output.
    *   Key files: `builder.py` (XML generation), `parameters.py` (parameter definitions).

*   **`utils/`**: **GENERIC UTILITIES**.
    *   Helper functions that are not specific to the scheduler domain.
    *   `io.py`: File I/O and caching utilities.
    *   `array_ops.py`: NumPy array manipulation.
    *   `string_ops.py`: String processing.

## üîë Key Functions

| Goal | Function | File |
|------|----------|------|
| **Run the Scheduler** | `build_schedule(config)` | `pipeline.py` |
| **Scheduling Logic** | `run_scheduler(inputs, config)` | `scheduler.py` |
| **Generate XML** | `generate_science_calendar(inputs, config, output_path)` | `science_calendar.py` |
| **Calculate Visibility** | `build_visibility_catalog(config, target_list, ...)` | `visibility/catalog.py` |

## ‚öôÔ∏è Configuration

The rework uses a unified configuration system with a single dataclass: `PandoraSchedulerConfig` in `config.py`.

**For command-line usage**, use the `run_scheduler.py` script (see Quick Usage above) with:
- CLI flags (`--start`, `--end`, `--output`, etc.)
- JSON config file via `--config example_scheduler_config.json`
- See `run_scheduler.py --help` for all available options

**For programmatic usage**:

```python
from datetime import datetime
from pathlib import Path
from pandorascheduler_rework.config import PandoraSchedulerConfig
from pandorascheduler_rework.pipeline import build_schedule

config = PandoraSchedulerConfig(
    window_start=datetime(2026, 2, 5),
    window_end=datetime(2026, 2, 12),
    output_dir=Path("./output"),
    targets_manifest=Path("./data"),
    # ... other parameters as needed
)

result = build_schedule(config)
```

## üß™ Tests and Development

Run tests with:

```bash
poetry run pytest tests/ -q
```

For debugging visibility generation, use `--verbose` to enable detailed logging.

## üìö Further Documentation

- **Codebase analysis**: `docs/CODEBASE_ANALYSIS.md`
- **Configuration reference**: `docs/EXAMPLE_SCHEDULER_CONFIG.md`
- **Quick start guide**: `QUICK_START.md` (repository root)
- **Example workflows**: `EXAMPLE_FULL_PIPELINE.md` (repository root)
